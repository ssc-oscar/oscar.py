
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>oscar &#8212; oscar 1.2.2 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for oscar</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">lzf</span>
<span class="c1"># da4 doesn&#39;t have libgit2-dev to install pygit2 yet</span>
<span class="c1"># import pygit2</span>
<span class="kn">from</span> <span class="nn">tokyocabinet</span> <span class="k">import</span> <span class="nb">hash</span> <span class="k">as</span> <span class="n">tch</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">tzinfo</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">fnvhash</span>


<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;1.2.2&#39;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Marat (@cmu.edu)&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;GPL v3&quot;</span>

<span class="n">PATHS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># data_type: (path, prefix_bit_length)</span>
    <span class="c1"># prefix length means that the data are split into 2**n files,</span>
    <span class="c1"># e.g. key is in 0..31 for prefix length of 5 bit.</span>

    <span class="c1"># The most critical: raw data for the initial storage, use in sweeps, 100TB da4+ backup</span>
    <span class="s1">&#39;commit_sequential_idx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/data/All.blobs/commit_</span><span class="si">{key}</span><span class="s1">.idx&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;commit_sequential_bin&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/data/All.blobs/commit_</span><span class="si">{key}</span><span class="s1">.bin&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;tree_sequential_idx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/data/All.blobs/blob_</span><span class="si">{key}</span><span class="s1">.idx&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;tree_sequential_bin&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/data/All.blobs/blob_</span><span class="si">{key}</span><span class="s1">.bin&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>

    <span class="c1"># critical - random access to trees and commits on da3 and da4, 10TB</span>
    <span class="s1">&#39;commit_random&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/fast/All.sha1c/commit_</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;tree_random&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/fast/All.sha1c/tree_</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>

    <span class="s1">&#39;blob_offset&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/fast/All.sha1o/sha1.blob_</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;blob_data&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/data/All.blobs/blob_</span><span class="si">{key}</span><span class="s1">.bin&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="c1"># the rest of x_data is currently unused:</span>
    <span class="c1"># &#39;commit_data&#39;: (&#39;/data/All.blobs/commit_{key}.bin&#39;,  # 7)</span>
    <span class="c1"># &#39;tree_data&#39;: (&#39;/data/All.blobs/tree_{key}.bin&#39;, 7)</span>
    <span class="c1"># &#39;tag_data&#39;: (&#39;/data/All.blobs/tag_{key}.bin&#39;, 7)</span>

    <span class="c1"># relations - good to have but not critical</span>
    <span class="s1">&#39;commit_projects&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/c2pFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;commit_children&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/c2ccFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;commit_blobs&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/c2bFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;commit_files&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/c2fFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;project_commits&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/p2cFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;author_commits&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/a2cFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;author_projects&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/a2pFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;author_trpath&#39;</span><span class="p">:(</span><span class="s1">&#39;/da0_data/basemaps/a2trpO.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;blob_commits&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/b2cFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;blob_authors&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/b2aFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;file_commits&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/f2cFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>

    <span class="c1">####  dictionary entries added after 5/12/19  #####</span>
    <span class="s1">&#39;file_blobs&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/f2bFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;commit_time_author&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/c2taFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;project_authors&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/p2aFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;blob_files&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/b2fFullP.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;commit_head&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/da0_data/basemaps/c2hFullO.</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>

    <span class="c1"># another way to get commit parents, currently unused</span>
    <span class="c1"># &#39;commit_parents&#39;: (&#39;/da0_data/basemaps/c2pcK.{key}.tch&#39;, 7)</span>

    <span class="c1"># SHA1 cache, on da3 and d4  668G</span>
    <span class="s1">&#39;blob_index_line&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/fast/All.sha1/sha1.blob_</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;tree_index_line&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/fast/All.sha1/sha1.tree_</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;commit_index_line&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/fast/All.sha1/sha1.commit_</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;tag_index_line&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/fast/All.sha1/sha1.tag_</span><span class="si">{key}</span><span class="s1">.tch&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">ObjectNotFound</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">unber</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; list</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Perl BER unpacking</span>
<span class="sd">    Format definition: from http://perldoc.perl.org/functions/pack.html</span>
<span class="sd">        (see &quot;w&quot; template description)</span>

<span class="sd">    BER is a way to pack several variable-length ints into one</span>
<span class="sd">    binary string. Here we do the reverse</span>

<span class="sd">    :param s: a binary string with packed values</span>
<span class="sd">    :return: a list of unpacked values</span>

<span class="sd">    &gt;&gt;&gt; unber(&#39;\x00\x83M&#39;)</span>
<span class="sd">    [0, 461]</span>
<span class="sd">    &gt;&gt;&gt; unber(&#39;\x83M\x96\x14&#39;)</span>
<span class="sd">    [461, 2836]</span>
<span class="sd">    &gt;&gt;&gt; unber(&#39;\x99a\x89\x12&#39;)</span>
<span class="sd">    [3297, 1170]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">acc</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">lzf_length</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; (int, int)</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Get length of uncompressed data from a header of Compress::LZF</span>
<span class="sd">    output. Check Compress::LZF sources for the definition of this bit magic</span>
<span class="sd">        (namely, LZF.xs, decompress_sv)</span>

<span class="sd">    :param raw_data: data compressed with Perl Compress::LZF</span>
<span class="sd">    :return: tuple of (header_size, uncompressed_content_length) in bytes</span>
<span class="sd">    &gt;&gt;&gt; lzf_length(&#39;\xc4\x9b&#39;)</span>
<span class="sd">    (2, 283)</span>
<span class="sd">    &gt;&gt;&gt; lzf_length(&#39;\xc3\xa4&#39;)</span>
<span class="sd">    (2, 228)</span>
<span class="sd">    &gt;&gt;&gt; lzf_length(&#39;\xc3\x8a&#39;)</span>
<span class="sd">    (2, 202)</span>
<span class="sd">    &gt;&gt;&gt; lzf_length(&#39;\xca\x87&#39;)</span>
<span class="sd">    (2, 647)</span>
<span class="sd">    &gt;&gt;&gt; lzf_length(&#39;\xe1\xaf\xa9&#39;)</span>
<span class="sd">    (3, 7145)</span>
<span class="sd">    &gt;&gt;&gt; lzf_length(&#39;\xe0\xa7\x9c&#39;)</span>
<span class="sd">    (3, 2524)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_data</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LZF compressed data are missing header&quot;</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">csize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span>
    <span class="k">while</span> <span class="n">mask</span> <span class="ow">and</span> <span class="n">csize</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span> <span class="ow">or</span> <span class="n">csize</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LZF compressed data header is corrupted&quot;</span><span class="p">)</span>
    <span class="n">usize</span> <span class="o">=</span> <span class="n">lower</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="n">usize</span> <span class="o">=</span> <span class="p">(</span><span class="n">usize</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">usize</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LZF compressed data header is corrupted&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">usize</span>


<span class="k">def</span> <span class="nf">decomp</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot; lzf wrapper to handle perl tweaks in Compress::LZF</span>
<span class="sd">    This function extracts uncompressed size header</span>
<span class="sd">    and then does usual lzf decompression.</span>
<span class="sd">    Please check Compress::LZF sources for the definition of this bit magic</span>

<span class="sd">    :param raw_data: data compressed with Perl Compress::LZF</span>
<span class="sd">    :return: string of unpacked data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">elif</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">usize</span> <span class="o">=</span> <span class="n">lzf_length</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lzf</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">start</span><span class="p">:],</span> <span class="n">usize</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cached_property</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Classic memoize with @property on top&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">slice20</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Slice raw_data into 20-byte chunks and hex encode each of them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">raw_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">),</span> <span class="mi">20</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">CommitTimezone</span><span class="p">(</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="c1"># a lightweight version of pytz._FixedOffset</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;fixed&#39;</span>

    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="c1"># daylight saving time - no info</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">seconds</span> <span class="o">//</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Timezone: </span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>


<span class="n">DAY_Z</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CommitTimezone</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">parse_commit_date</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse date string of authored_at/commited_at</span>

<span class="sd">    git log time is in the original timezone</span>
<span class="sd">        gitpython - same as git log (also, it has the correct timezone)</span>
<span class="sd">    unix timestamps (used internally by commit objects) are in UTC</span>
<span class="sd">        datetime.fromtimestamp without a timezone will convert it to host tz</span>
<span class="sd">    github api is in UTC (this is what trailing &#39;Z&#39; means)</span>

<span class="sd">    :param timestamp: Commit.authored_at or Commit.commited_at,</span>
<span class="sd">        e.g. &#39;1337145807 +1100&#39;</span>
<span class="sd">    :type timestamp: str</span>
<span class="sd">    :return: UTC datetime</span>
<span class="sd">    :rtype: datetime.datetime or None</span>

<span class="sd">    &gt;&gt;&gt; parse_commit_date(&#39;1337145807 +1100&#39;)</span>
<span class="sd">    datetime.datetime(2012, 5, 16, 16, 23, 27, tzinfo=&lt;Timezone: 11:00&gt;)</span>
<span class="sd">    &gt;&gt;&gt; parse_commit_date(&#39;3337145807 +1100&#39;) is None</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">tz</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">tz</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">sign</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">tz</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">CommitTimezone</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># i.e. if timestamp or timezone is invalid</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># timestamp is in the future</span>
    <span class="k">if</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">dt</span>


<span class="c1"># Pool of open TokyoCabinet databases to save few milliseconds on opening</span>
<span class="n">_TCH_POOL</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_get_tch</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tch&#39;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;.tch&#39;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_TCH_POOL</span><span class="p">:</span>
        <span class="n">_TCH_POOL</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">tch</span><span class="o">.</span><span class="n">Hash</span><span class="p">()</span>
        <span class="n">_TCH_POOL</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tch</span><span class="o">.</span><span class="n">HDBOREADER</span> <span class="o">|</span> <span class="n">tch</span><span class="o">.</span><span class="n">HDBONOLCK</span><span class="p">)</span>
        <span class="c1"># _TCH_POOL[path].setmutex()</span>
    <span class="k">return</span> <span class="n">_TCH_POOL</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">read_tch</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read a value from a Tokyo Cabinet file by the specified key</span>
<span class="sd">    Main purpose of this method is to cached open .tch handlers</span>
<span class="sd">    in _TCH_POOL to speedup reads</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_tch</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span>
        <span class="c1">#raise IOError(&quot;Tokyocabinet file &quot; + path + &quot; not found&quot;)</span>
    <span class="c1">#except KeyError:</span>
     <span class="c1">#   if silent:</span>
     <span class="c1">#       return &#39;&#39;</span>
     <span class="c1">#   raise ObjectNotFound(path + &quot; &quot; + key)</span>

<span class="k">def</span> <span class="nf">tch_keys</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_get_tch</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">fwmkeys</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">use_fnv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># type: (str, str, bool) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot; Get path to a file using data type and object key (for sharding) &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">prefix_length</span> <span class="o">=</span> <span class="n">PATHS</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">fnvhash</span><span class="o">.</span><span class="n">fnv1a_32</span><span class="p">(</span><span class="n">object_key</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_fnv</span> <span class="k">else</span> <span class="nb">ord</span><span class="p">(</span><span class="n">object_key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">prefix_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Base</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># fnv keys are used for non-git objects, such as files, projects and authors</span>
    <span class="n">use_fnv_keys</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_keys_registry_dtype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param key: unique identifier for an object of this type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="s1">&#39;OscarBase&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; sha = &#39;f2a7fcdc51450ab03cb364415f14e634fa69b62c&#39;</span>
<span class="sd">        &gt;&gt;&gt; Commit(sha) == Commit(sha)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; Commit(sha) == Blob(sha)</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">key</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>

    <span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_fnv_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_tch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resolve the path and read .tch&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">read_tch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>

<div class="viewcode-block" id="_Base.all"><a class="viewcode-back" href="../index.html#oscar._Base.all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate all objects of the given type</span>

<span class="sd">        This might be useful to get a list of all projects, or a list of</span>
<span class="sd">        all file names.</span>

<span class="sd">        Returns:</span>
<span class="sd">            a generator of `Project` objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_keys_registry_dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">NotImplemented</span>

        <span class="n">base_path</span><span class="p">,</span> <span class="n">prefix_length</span> <span class="o">=</span> <span class="n">PATHS</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_keys_registry_dtype</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">file_prefix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">prefix_length</span><span class="p">):</span>
            <span class="n">tch_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">file_prefix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tch_keys</span><span class="p">(</span><span class="n">tch_path</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">cls</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">GitObject</span><span class="p">(</span><span class="n">_Base</span><span class="p">):</span>
    <span class="n">use_fnv_keys</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate ALL objects of this type (all projects, all times) &quot;&quot;&quot;</span>
        <span class="n">base_idx_path</span><span class="p">,</span> <span class="n">prefix_length</span> <span class="o">=</span> <span class="n">PATHS</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_sequential_idx&#39;</span><span class="p">]</span>
        <span class="n">base_bin_path</span><span class="p">,</span> <span class="n">prefix_length</span> <span class="o">=</span> <span class="n">PATHS</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_sequential_bin&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">prefix_length</span><span class="p">):</span>
            <span class="n">idx_path</span> <span class="o">=</span> <span class="n">base_idx_path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="n">bin_path</span> <span class="o">=</span> <span class="n">base_bin_path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="n">datafile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">idx_path</span><span class="p">):</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># cls.type == &quot;blob&quot;:</span>
                    <span class="c1"># usually, it&#39;s true for blobs;</span>
                    <span class="c1"># however, some blobs follow common pattern</span>
                    <span class="n">offset</span><span class="p">,</span> <span class="n">comp_length</span><span class="p">,</span> <span class="n">full_length</span><span class="p">,</span> <span class="n">sha</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">offset</span><span class="p">,</span> <span class="n">comp_length</span><span class="p">,</span> <span class="n">sha</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

                <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">decomp</span><span class="p">(</span><span class="n">datafile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">comp_length</span><span class="p">)))</span>

                <span class="k">yield</span> <span class="n">obj</span>
            <span class="n">datafile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sha</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param sha: either a 40 char hex or a 20 bytes binary SHA1 hash</span>
<span class="sd">        &gt;&gt;&gt; sha = &#39;05cf84081b63cda822ee407e688269b494a642de&#39;</span>
<span class="sd">        &gt;&gt;&gt; GitObject(sha.decode(&#39;hex&#39;)).sha == sha</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; GitObject(sha).bin_sha == sha.decode(&#39;hex&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sha</span> <span class="o">=</span> <span class="n">sha</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_sha</span> <span class="o">=</span> <span class="n">sha</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sha</span> <span class="o">=</span> <span class="n">sha</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_sha</span> <span class="o">=</span> <span class="n">sha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid SHA1 hash: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sha</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GitObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="c1"># overriding to use bin_sha instead of the key (which is sha)</span>
        <span class="k">return</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_sha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_fnv_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_tch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resolve the path and read .tch&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">read_tch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_sha</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;commit&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="c1"># default implementation will only work for commits and trees</span>
        <span class="k">return</span> <span class="n">decomp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_random&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">string_sha</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manually compute blob sha from its content passed as `data`.</span>

<span class="sd">        The main use case for this method is to identify source of a file.</span>

<span class="sd">        Blob SHA is computed from a string:</span>
<span class="sd">        &quot;blob &lt;file content length as str&gt;&lt;null byte&gt;&lt;file content&gt;&quot;</span>

<span class="sd">        # https://gist.github.com/masak/2415865</span>
<span class="sd">        Commit SHAs are computed in a similar way</span>
<span class="sd">        &quot;commit &lt;commit length as str&gt;&lt;null byte&gt;&lt;commit content&gt;&quot;</span>

<span class="sd">        note that commit content includes committed/authored date</span>

<span class="sd">        Args:</span>
<span class="sd">            data (str): content of the GitObject to get hash for</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: 40-byte hex SHA1 hash</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sha1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sha1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">file_sha</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">buffsize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">sha1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">buffsize</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sha1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; print(Commit(&#39;f2a7fcdc51450ab03cb364415f14e634fa69b62c&#39;))</span>
<span class="sd">        tree d4ddbae978c9ec2dc3b7b3497c2086ecf7be7d9d</span>
<span class="sd">        parent 66acf0a046a02b48e0b32052a17f1e240c2d7356</span>
<span class="sd">        author Pavel Puchkin &lt;neoascetic@gmail.com&gt; 1375321509 +1100</span>
<span class="sd">        committer Pavel Puchkin &lt;neoascetic@gmail.com&gt; 1375321597 +1100</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        License changed :P</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>


<div class="viewcode-block" id="Blob"><a class="viewcode-back" href="../index.html#oscar.Blob">[docs]</a><span class="k">class</span> <span class="nc">Blob</span><span class="p">(</span><span class="n">GitObject</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;blob&#39;</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
        <span class="k">return</span> <span class="n">length</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">string_sha</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; Blob.string_sha(&#39;Hello world!&#39;)</span>
<span class="sd">        &#39;6769dd60bdf536a83c9353272157893043e9f7d0&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return pygit2.hash(data)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Blob</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">string_sha</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">file_sha</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manually compute blob sha from a file content.</span>

<span class="sd">        Similar to string_sha</span>
<span class="sd">        &gt;&gt;&gt; Blob.file_sha(&#39;LICENSE&#39;)</span>
<span class="sd">        &#39;94a9ed024d3859793618152ea559a168bbcbb5e2&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return pygit2.hashfile(path)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Blob</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">file_sha</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get offset and length of the blob data in the storage &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">unber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;blob_offset&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># empty read -&gt; value not found</span>
            <span class="k">raise</span> <span class="n">ObjectNotFound</span><span class="p">(</span><span class="s1">&#39;Blob data not found (bad sha?)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Content of the blob &quot;&quot;&quot;</span>
        <span class="n">offset</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
        <span class="c1"># no caching here to stay thread-safe</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="s1">&#39;blob_data&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">decomp</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">commit_shas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; SHAs of Commits in which this blob have been</span>
<span class="sd">        introduced or modified.</span>

<span class="sd">        **NOTE: commits removing this blob are not included**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">slice20</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;blob_commits&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Commits where this blob has been added or changed</span>

<span class="sd">        **NOTE: commits removing this blob are not included**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Commit</span><span class="p">(</span><span class="n">bin_sha</span><span class="p">)</span> <span class="k">for</span> <span class="n">bin_sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_shas</span><span class="p">)</span></div>



<div class="viewcode-block" id="Tree"><a class="viewcode-back" href="../index.html#oscar.Tree">[docs]</a><span class="k">class</span> <span class="nc">Tree</span><span class="p">(</span><span class="n">GitObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A representation of git tree object, basically - a directory.</span>

<span class="sd">    Trees are iterable. Each element of the iteration is a 3-tuple:</span>
<span class="sd">    `(mode, filename, sha)`</span>

<span class="sd">    - `mode` is an ASCII decimal **string** similar to file mode</span>
<span class="sd">        in Unix systems. Subtrees always have mode &quot;40000&quot;</span>
<span class="sd">    - `filename` is a string filename, not including directories</span>
<span class="sd">    - `sha` is a 40 bytes hex string representing file content Blob SHA</span>

<span class="sd">    .. Note:: iteration is not recursive.</span>
<span class="sd">        For a recursive walk, use Tree.traverse() or Tree.files</span>

<span class="sd">    Both files and blobs can be checked for membership,</span>
<span class="sd">    either by their id (filename or SHA) or a corresponding object:</span>

<span class="sd">        &gt;&gt;&gt; tree = Tree(&quot;d4ddbae978c9ec2dc3b7b3497c2086ecf7be7d9d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; &#39;.gitignore&#39; in tree</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; File(&#39;.keep&#39;) in tree</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; &#39;83d22195edc1473673f1bf35307aea6edf3c37e3&#39; in tree</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; Blob(&#39;83d22195edc1473673f1bf35307aea6edf3c37e3&#39;) in tree</span>
<span class="sd">        True</span>

<span class="sd">    `len(tree)` returns the number of files under the tree, including files in</span>
<span class="sd">    subtrees but not the subtrees themselves:</span>

<span class="sd">        &gt;&gt;&gt; len(Tree(&quot;d4ddbae978c9ec2dc3b7b3497c2086ecf7be7d9d&quot;))</span>
<span class="sd">        16</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;tree&#39;</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Unpack binary tree structures, yielding 3-tuples of</span>
<span class="sd">        (mode (ASCII decimal), filename, sha (40 bytes hex))</span>

<span class="sd">        Format description:  https://stackoverflow.com/questions/14790681/</span>
<span class="sd">            mode   (ASCII encoded decimal)</span>
<span class="sd">            SPACE (\0x20)</span>
<span class="sd">            filename</span>
<span class="sd">            NULL (\x00)</span>
<span class="sd">            20-byte binary hash</span>
<span class="sd">        &gt;&gt;&gt; len(list(Tree(&quot;d4ddbae978c9ec2dc3b7b3497c2086ecf7be7d9d&quot;)))</span>
<span class="sd">        6</span>
<span class="sd">        &gt;&gt;&gt; all(len(line) == 3</span>
<span class="sd">        ...     for line in Tree(&quot;954829887af5d9071aa92c427133ca2cdd0813cc&quot;))</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># mode</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># file name</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># sha</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">21</span>
            <span class="k">yield</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">File</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Blob</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blob_shas</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blob_shas</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>

<div class="viewcode-block" id="Tree.traverse"><a class="viewcode-back" href="../index.html#oscar.Tree.traverse">[docs]</a>    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recursively traverse the tree</span>
<span class="sd">        This will generate 3-tuples of the same format as direct tree</span>
<span class="sd">        iteration, but will recursively include subtrees content.</span>

<span class="sd">        :return: generator of (mode, filename, blob/tree sha)</span>

<span class="sd">        &gt;&gt;&gt; c = Commit(&quot;1e971a073f40d74a1e72e07c682e1cba0bae159b&quot;)</span>
<span class="sd">        &gt;&gt;&gt; len(list(c.tree.traverse()))</span>
<span class="sd">        8</span>
<span class="sd">        &gt;&gt;&gt; c = Commit(&#39;e38126dbca6572912013621d2aa9e6f7c50f36bc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; len(list(c.tree.traverse()))</span>
<span class="sd">        36</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">sha</span>
            <span class="c1"># trees are always 40000:</span>
            <span class="c1"># https://stackoverflow.com/questions/1071241</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;40000&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">mode2</span><span class="p">,</span> <span class="n">fname2</span><span class="p">,</span> <span class="n">sha2</span> <span class="ow">in</span> <span class="n">Tree</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span><span class="o">.</span><span class="n">traverse</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="n">mode2</span><span class="p">,</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">fname2</span><span class="p">,</span> <span class="n">sha2</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Formatted tree content, including recursive files and subtrees</span>
<span class="sd">        It is intended for debug purposes only.</span>

<span class="sd">        :return: multiline string, where each line contains mode, name and sha,</span>
<span class="sd">            with subtrees expanded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; print(Tree(&quot;954829887af5d9071aa92c427133ca2cdd0813cc&quot;))</span>
<span class="sd">        100644 __init__.py ff1f7925b77129b31938e76b5661f0a2c4500556</span>
<span class="sd">        100644 admin.py d05d461b48a8a5b5a9d1ea62b3815e089f3eb79b</span>
<span class="sd">        100644 models.py d1d952ee766d616eae5bfbd040c684007a424364</span>
<span class="sd">        40000 templates 7ff5e4c9bd3ce6ab500b754831d231022b58f689</span>
<span class="sd">        40000 templatetags e5e994b0be2c9ce6af6f753275e7d8c29ccf75ce</span>
<span class="sd">        100644 urls.py e9cb0c23a7f6683911305efff91dcabadb938794</span>
<span class="sd">        100644 utils.py 2cfbd298f18a75d1f0f51c2f6a1f2fcdf41a9559</span>
<span class="sd">        100644 views.py 973a78a1fe9e69d4d3b25c92b3889f7e91142439</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A dict of all files and their content/blob sha under this tree.</span>
<span class="sd">        It includes recursive files (i.e. files in subdirectories).</span>
<span class="sd">        It does NOT include subdirectories themselves.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">fname</span><span class="p">:</span> <span class="n">sha</span>
                <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">()</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;40000&quot;</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blob_shas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A tuple of all file content shas, including files in subdirectories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A generator of Blob objects with file content.</span>
<span class="sd">        It does include files in subdirectories.</span>

<span class="sd">        &gt;&gt;&gt; tuple(Tree(&#39;d20520ef8c1537a42628b72d481b8174c0a1de84&#39;).blobs</span>
<span class="sd">        ...       )  # doctest: +ELLIPSIS, +NORMALIZE_WHITESPACE</span>
<span class="sd">        (&lt;Blob: 2bdf5d686c6cd488b706be5c99c3bb1e166cf2f6&gt;, ...,</span>
<span class="sd">         &lt;Blob: c006bef767d08b41633b380058a171b7786b71ab&gt;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Blob</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="k">for</span> <span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blob_shas</span><span class="p">)</span></div>


<div class="viewcode-block" id="Commit"><a class="viewcode-back" href="../index.html#oscar.Commit">[docs]</a><span class="k">class</span> <span class="nc">Commit</span><span class="p">(</span><span class="n">GitObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A git commit object.</span>

<span class="sd">    Commits have some special properties.</span>
<span class="sd">    Most of object properties provided by this project are lazy, i.e. they are</span>
<span class="sd">    computed when you access them for the first time.</span>
<span class="sd">    The following `Commit` properties will be instantiated all at once on the</span>
<span class="sd">    first access to *any* of them.</span>

<span class="sd">    - :data:`tree`:           root `Tree` of the commit</span>
<span class="sd">    - :data:`parent_shas`:    tuple of parent commit sha hashes</span>
<span class="sd">    - :data:`message`:        str, first line of the commit message</span>
<span class="sd">    - :data:`full_message`:   str, full commit message</span>
<span class="sd">    - :data:`author`:         str, Name &lt;email&gt;</span>
<span class="sd">    - :data:`authored_at`:    str, unix_epoch+timezone</span>
<span class="sd">    - :data:`committer`:      str, Name &lt;email&gt;</span>
<span class="sd">    - :data:`committed_at`:   str, unix_epoch+timezone</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;commit&#39;</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mimic special properties:</span>
<span class="sd">            tree:           root Tree of the commit</span>
<span class="sd">            parent_shas:    tuple of parent commit sha hashes</span>
<span class="sd">            message:        str, first line of the commit message</span>
<span class="sd">            full_message:   str, full commit message</span>
<span class="sd">            author:         str, Name &lt;email&gt;</span>
<span class="sd">            authored_at:    timezone-aware datetime or None (if invalid)</span>
<span class="sd">            committer:      str, Name &lt;email&gt;</span>
<span class="sd">            committed_at:   timezone-aware datetime or None (if invalid)</span>
<span class="sd">            signature:      str or None, PGP signature</span>

<span class="sd">        Commit: https://github.com/user2589/minicms/commit/e38126db</span>
<span class="sd">        &gt;&gt;&gt; c = Commit(&#39;e38126dbca6572912013621d2aa9e6f7c50f36bc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; c.author.startswith(&#39;Marat&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; c.authored_at</span>
<span class="sd">        datetime.datetime(2012, 5, 19, 1, 14, 8, tzinfo=&lt;Timezone: 11:00&gt;)</span>
<span class="sd">        &gt;&gt;&gt; c.tree.sha</span>
<span class="sd">        &#39;6845f55f47ddfdbe4628a83fdaba35fa4ae3c894&#39;</span>
<span class="sd">        &gt;&gt;&gt; len(c.parent_shas)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; c.parent_shas[0]</span>
<span class="sd">        &#39;ab124ab4baa42cd9f554b7bb038e19d4e3647957&#39;</span>
<span class="sd">        &gt;&gt;&gt; c.committed_at</span>
<span class="sd">        datetime.datetime(2012, 5, 19, 1, 14, 8, tzinfo=&lt;Timezone: 11:00&gt;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_shas&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;full_message&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;committer&#39;</span><span class="p">,</span> <span class="s1">&#39;authored_at&#39;</span><span class="p">,</span> <span class="s1">&#39;committed_at&#39;</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parent_shas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">reading_signature</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reading_signature</span><span class="p">:</span>
                <span class="c1"># examples:</span>
                <span class="c1">#   1cc6f4418dcc09f64dcbb0410fec76ceaa5034ab</span>
                <span class="c1">#   cbbc685c45bdff4da5ea0984f1dd3a73486b4556</span>
                <span class="n">signature</span> <span class="o">+=</span> <span class="n">line</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;-----END PGP SIGNATURE-----&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
                    <span class="n">reading_signature</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">):</span>  <span class="c1"># mergetag object, not supported (yet?)</span>
                <span class="c1"># example: c1313c68c7f784efaf700fbfb771065840fc260a</span>
                <span class="k">continue</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>  <span class="c1"># sometimes there is an empty line after gpgsig</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected header in commit &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;parent&quot;</span><span class="p">:</span>  <span class="c1"># multiple parents possible</span>
                <span class="n">parent_shas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;author&quot;</span><span class="p">:</span>
                <span class="c1"># author name can have arbitrary number of spaces while</span>
                <span class="c1"># timestamp is guaranteed to have one, so rsplit</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">authored_at</span> <span class="o">=</span> <span class="n">parse_commit_date</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;committer&quot;</span><span class="p">:</span>
                <span class="c1"># same logic as author</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">committer</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">committed_at</span> <span class="o">=</span> <span class="n">parse_commit_date</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;gpgsig&#39;</span><span class="p">:</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">reading_signature</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_shas</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parent_shas</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compare two Commits.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent (Commit): another commit to compare to.</span>
<span class="sd">                Expected order is `diff = child_commit - parent_commit`</span>

<span class="sd">        Returns:</span>
<span class="sd">            Generator[Tuple[Optional[str], Optional[str], Optional[str], Optional[str]]]:</span>
<span class="sd">                4-tuples: `(old_path, new_path, old_sha, new_sha)`</span>

<span class="sd">            Examples:</span>
<span class="sd">            - a new file &#39;setup.py&#39; was created:</span>
<span class="sd">                `(None, &#39;setup.py&#39;, None, &#39;file_sha&#39;)`</span>
<span class="sd">            - an existing &#39;setup.py&#39; was deleted:</span>
<span class="sd">                `(&#39;setup.py&#39;, None, &#39;old_file_sha&#39;, None)`</span>
<span class="sd">            - setup.py.old was renamed to setup.py, content unchanged:</span>
<span class="sd">                `(&#39;setup.py.old&#39;, &#39;setup.py&#39;, &#39;file_sha&#39;, &#39;file_sha&#39;)`</span>
<span class="sd">            - setup.py was edited:</span>
<span class="sd">                `(&#39;setup.py&#39;, &#39;setup.py&#39;, &#39;old_file_sha&#39;, &#39;new_file_sha&#39;)`</span>
<span class="sd">            - setup.py.old was edited and renamed to setup.py:</span>
<span class="sd">                `(&#39;setup.py.old&#39;, &#39;setup.py&#39;, &#39;old_file_sha&#39;, &#39;new_file_sha&#39;)`</span>

<span class="sd">        Detecting the last one is computationally expensive. You can adjust this</span>
<span class="sd">        behaviour by passing the `threshold` parameter, which is 0.5 by default.</span>
<span class="sd">        It means that if roughly 50% of the file content is the same,</span>
<span class="sd">        it is considered a match. `threshold=1` means that only exact</span>
<span class="sd">        matches are considered, effectively disabling this comparison.</span>
<span class="sd">        If threshold is set to 0, any pair of deleted and added file will be</span>
<span class="sd">        considered renamed and edited; this last case doesn&#39;t make much sense so</span>
<span class="sd">        don&#39;t set it too low.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">sha</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_shas</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Comparing non-adjacent commits might be &quot;</span>
                          <span class="s2">&quot;computationally expensive. Proceed with caution.&quot;</span><span class="p">)</span>

        <span class="c1"># filename: (blob sha before, blob sha after)</span>
        <span class="n">new_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">files</span>
        <span class="n">new_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">old_files</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">files</span>
        <span class="n">old_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># unchanged_paths</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">new_paths</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">old_paths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">new_files</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">!=</span> <span class="n">old_files</span><span class="p">[</span><span class="n">fname</span><span class="p">]:</span>
                <span class="c1"># i.e. the Blob sha is the same</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">old_files</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="n">new_files</span><span class="p">[</span><span class="n">fname</span><span class="p">])</span>

        <span class="n">added_paths</span> <span class="o">=</span> <span class="n">new_paths</span> <span class="o">-</span> <span class="n">old_paths</span>
        <span class="n">deleted_paths</span> <span class="o">=</span> <span class="n">old_paths</span> <span class="o">-</span> <span class="n">new_paths</span>

        <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># i.e. only exact matches are considered</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">added_paths</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">new_files</span><span class="p">[</span><span class="n">fname</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">deleted_paths</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">old_files</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># search for matches</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">()</span>
        <span class="n">added_blobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">Blob</span><span class="p">(</span><span class="n">new_files</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">added_paths</span><span class="p">}</span>
        <span class="n">deleted_blobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">Blob</span><span class="p">(</span><span class="n">old_files</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">deleted_paths</span><span class="p">}</span>
        <span class="c1"># for each added blob, try to find a match in deleted blobs</span>
        <span class="c1">#   if there is a match, signal a rename and remove from deleted</span>
        <span class="c1">#   if there is no match, signal a new file</span>
        <span class="c1"># unused deleted blobs are indeed deleted</span>
        <span class="k">for</span> <span class="n">added_fname</span><span class="p">,</span> <span class="n">added_blob</span> <span class="ow">in</span> <span class="n">added_blobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">added_blob</span><span class="p">)</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">deleted_fname</span><span class="p">,</span> <span class="n">deleted_blob</span> <span class="ow">in</span> <span class="n">deleted_blobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sm</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">deleted_blob</span><span class="p">)</span>
                <span class="c1"># use quick checks first (lower bound by length diff)</span>
                <span class="k">if</span> <span class="n">sm</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">threshold</span> \
                        <span class="ow">and</span> <span class="n">sm</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">threshold</span> \
                        <span class="ow">and</span> <span class="n">sm</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">deleted_fname</span><span class="p">,</span> <span class="n">added_fname</span><span class="p">,</span> <span class="n">deleted_blob</span><span class="p">,</span> <span class="n">added_blob</span><span class="p">)</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">deleted_blobs</span><span class="p">[</span><span class="n">deleted_fname</span><span class="p">])</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>  <span class="c1"># this is a new file</span>
                <span class="k">yield</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">added_fname</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">added_blob</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">deleted_fname</span><span class="p">,</span> <span class="n">deleted_blob</span> <span class="ow">in</span> <span class="n">deleted_blobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">deleted_fname</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">deleted_blob</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A generator of parent commits.</span>
<span class="sd">        If you only need hashes (and not `Commit` objects),</span>
<span class="sd">        use `.parent_sha` instead</span>

<span class="sd">        Commit: https://github.com/user2589/minicms/commit/e38126db</span>
<span class="sd">        &gt;&gt;&gt; c = Commit(&#39;e38126dbca6572912013621d2aa9e6f7c50f36bc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; tuple(c.parents)</span>
<span class="sd">        (&lt;Commit: ab124ab4baa42cd9f554b7bb038e19d4e3647957&gt;,)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Commit</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="k">for</span> <span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_shas</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">project_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># type: () -&gt; tuple</span>
        <span class="sd">&quot;&quot;&quot; URIs of projects including this commit.</span>
<span class="sd">        This property can be used to find all forks of a project</span>
<span class="sd">        by its first commit.</span>

<span class="sd">        Commit: https://github.com/user2589/minicms/commit/f2a7fcdc</span>
<span class="sd">        &gt;&gt;&gt; c = Commit(&#39;f2a7fcdc51450ab03cb364415f14e634fa69b62c&#39;)</span>
<span class="sd">        &gt;&gt;&gt; isinstance(c.project_names, tuple)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; len(c.project_names) &gt; 0</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; &#39;user2589_minicms&#39; in c.project_names</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">decomp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;commit_projects&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">project_name</span>
                     <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]</span>
                     <span class="k">if</span> <span class="n">project_name</span> <span class="ow">and</span> <span class="n">project_name</span> <span class="o">!=</span> <span class="s1">&#39;EMPTY&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A generator of `Project` s, in which this commit is included.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Project</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span> <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_names</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">child_shas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Children commit binary sha hashes.</span>
<span class="sd">        Basically, this is a reverse parent_shas</span>

<span class="sd">        Commit: https://github.com/user2589/minicms/commit/1e971a07</span>
<span class="sd">        &gt;&gt;&gt; Commit(&#39;1e971a073f40d74a1e72e07c682e1cba0bae159b&#39;).child_shas</span>
<span class="sd">        (&#39;9bd02434b834979bb69d0b752a403228f2e385e8&#39;,)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">slice20</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;commit_children&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A generator of children `Commit` objects</span>

<span class="sd">        Commit: https://github.com/user2589/minicms/commit/1e971a07</span>
<span class="sd">        &gt;&gt;&gt; tuple(Commit(&#39;1e971a073f40d74a1e72e07c682e1cba0bae159b&#39;).children)</span>
<span class="sd">        (&lt;Commit: 9bd02434b834979bb69d0b752a403228f2e385e8&gt;,)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Commit</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="k">for</span> <span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_shas</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">blob_shas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; SHA hashes of all blobs in the commit</span>

<span class="sd">        &gt;&gt;&gt; Commit(&#39;af0048f4aac8f4760bf9b816e01524d7fb20a3fc&#39;).blob_shas</span>
<span class="sd">        ...        # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        (&#39;b2f49ffef1c8d7ce83a004b34035f917713e2766&#39;,</span>
<span class="sd">         &#39;c92011c5ccc32a9248bd929a6e56f846ac5b8072&#39;,</span>
<span class="sd">         &#39;bf3c2d2df2ef710f995b590ac3e2c851b592c871&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">blob_shas</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">changed_file_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">decomp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;commit_files&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">files_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed_file_names</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blob_shas_rel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This relation is known to miss every first file in all trees.</span>
<span class="sd">        Consider using Commit.tree.blobs as a slower but more accurate</span>
<span class="sd">        alternative.</span>

<span class="sd">        When this relation passes the test, please replace blob_sha with it</span>
<span class="sd">        It should be faster but as of now it is not accurate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;This relation is known to miss every first file in all trees. &quot;</span>
            <span class="s2">&quot;Consider using Commit.tree.blobs as a slower but more accurate &quot;</span>
            <span class="s2">&quot;alternative&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slice20</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;commit_blobs&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A generator of `Blob` objects included in this commit</span>

<span class="sd">        &gt;&gt;&gt; tuple(Commit(&#39;af0048f4aac8f4760bf9b816e01524d7fb20a3fc&#39;).blobs)</span>
<span class="sd">        ...              # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        (&lt;Blob: b2f49ffef1c8d7ce83a004b34035f917713e2766&gt;,</span>
<span class="sd">         &lt;Blob: c92011c5ccc32a9248bd929a6e56f846ac5b8072&gt;,</span>
<span class="sd">         &lt;Blob: bf3c2d2df2ef710f995b590ac3e2c851b592c871&gt;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Blob</span><span class="p">(</span><span class="n">bin_sha</span><span class="p">)</span> <span class="k">for</span> <span class="n">bin_sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blob_shas</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">decomp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;commit_files&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">file_name</span> 
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">file_name</span> <span class="ow">and</span> <span class="n">file_name</span> <span class="o">!=</span> <span class="s1">&#39;EMPTY&#39;</span><span class="p">)</span></div>

<span class="k">class</span> <span class="nc">Commit_info</span><span class="p">(</span><span class="n">GitObject</span><span class="p">):</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">time_author</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;commit_time_author&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">time_author</span> 
        <span class="k">for</span> <span class="n">time_author</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)))</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">slice20</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;commit_head&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">data</span> 

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">GitObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Tag doesn&#39;t have any functionality associated.</span>
<span class="sd">    You can&#39;t really do anything useful with it yet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;tag&#39;</span>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../index.html#oscar.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="n">_Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Projects are initialized with a URI:</span>
<span class="sd">        - Github: `{user}_{repo}`, e.g. `user2589_minicms`</span>
<span class="sd">        - Gitlab: `gl_{user}_{repo}`</span>
<span class="sd">        - Bitbucket: `bb_{user}_{repo}`</span>
<span class="sd">        - Bioconductor: `bioconductor.org_{user}_{repo}`</span>
<span class="sd">        - kde: `kde.org_{user}_{repo}`</span>
<span class="sd">        - drupal: `drupal.org_{user}_{repo}` </span>
<span class="sd">        - Googlesouce: `android.googlesource.com_{repo}_{user}`</span>
<span class="sd">        - Linux kernel: `git.kernel.org_{user}_{repo}`</span>
<span class="sd">        - PostgreSQL: `git.postgresql.org_{user}_{repo}`</span>
<span class="sd">        - GNU Savannah: `git.savannah.gnu.org_{user}_{repo}`</span>
<span class="sd">        - ZX2C4: `git.zx2c4.com_{user}_{repo}`</span>
<span class="sd">        - GNOME: `gitlab.gnome.org_{user}_{repo}`</span>
<span class="sd">        - repo.or.cz: `repo.or.cz_{user}_{repo}`</span>
<span class="sd">        - Salsa: `salsa.debian.org_{user}_{repo}`</span>
<span class="sd">        - SourceForge: `sourceforge.net_{user}_{repo}`</span>
<span class="sd">  </span>
<span class="sd">    Projects are iterable:</span>

<span class="sd">        &gt;&gt;&gt; for commit in Project(&#39;user2589_minicms&#39;):  # doctest: +SKIP</span>
<span class="sd">        ...     print(commit.sha)</span>

<span class="sd">    Commits can be checked for membership in a project, either by their SHA</span>
<span class="sd">    hash or by a Commit object itself:</span>

<span class="sd">        Commit: https://github.com/user2589/minicms/commit/e38126db</span>
<span class="sd">        &gt;&gt;&gt; sha = &#39;e38126dbca6572912013621d2aa9e6f7c50f36bc&#39;</span>
<span class="sd">        &gt;&gt;&gt; sha in Project(&#39;user2589_minicms&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; Commit(sha) in Project(&#39;user2589_minicms&#39;)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;project&#39;</span>
    <span class="n">_keys_registry_dtype</span> <span class="o">=</span> <span class="s1">&#39;project_commits&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Project</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generator of all commits in the project.</span>
<span class="sd">        Order of commits is not guaranteed</span>

<span class="sd">        &gt;&gt;&gt; commits = tuple(Project(&#39;user2589_minicms&#39;))</span>
<span class="sd">        &gt;&gt;&gt; len(commits) &gt; 60</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(commits[0], Commit)</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_shas</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">Commit</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span>
                <span class="n">author</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span>
            <span class="k">except</span> <span class="n">ObjectNotFound</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">author</span> <span class="o">!=</span> <span class="s1">&#39;GitHub Merge Button &lt;merge-button@github.com&gt;&#39;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Commit</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">key</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_shas</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">commit_shas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; SHA1 of all commits in the project</span>

<span class="sd">        &gt;&gt;&gt; Project(&#39;user2589_django-currencies&#39;).commit_shas</span>
<span class="sd">        ...         # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        (&#39;2dbcd43f077f2b5511cc107d63a0b9539a6aa2a7&#39;,</span>
<span class="sd">         &#39;7572fc070c44f85e2a540f9a5a05a95d1dd2662d&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tch_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="s1">&#39;project_commits&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slice20</span><span class="p">(</span><span class="n">read_tch</span><span class="p">(</span><span class="n">tch_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A generator of all Commit objects in the project.</span>
<span class="sd">        It has the same effect as iterating a `Project` instance itself,</span>
<span class="sd">        with some additional validation of commit dates.</span>

<span class="sd">        &gt;&gt;&gt; tuple(Project(&#39;user2589_django-currencies&#39;).commits)</span>
<span class="sd">        ...       # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        (&lt;Commit: 2dbcd43f077f2b5511cc107d63a0b9539a6aa2a7&gt;,</span>
<span class="sd">         &lt;Commit: 7572fc070c44f85e2a540f9a5a05a95d1dd2662d&gt;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">commits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">tails</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commits</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">parent_shas</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">authored_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tails</span><span class="p">:</span>
            <span class="n">min_date</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">authored_at</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tails</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># i.e. if all tails have invalid date</span>
            <span class="n">min_date</span> <span class="o">=</span> <span class="n">DAY_Z</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">authored_at</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">authored_at</span> <span class="o">&lt;</span> <span class="n">min_date</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">authored_at</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">yield</span> <span class="n">c</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the HEAD commit of the repository</span>

<span class="sd">        &gt;&gt;&gt; Project(&#39;user2589_minicms&#39;).head</span>
<span class="sd">        &lt;Commit: f2a7fcdc51450ab03cb364415f14e634fa69b62c&gt;</span>
<span class="sd">        &gt;&gt;&gt; Project(&#39;RoseTHERESA_SimpleCMS&#39;).head</span>
<span class="sd">        &lt;Commit: a47afa002ccfd3e23920f323b172f78c5c970250&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sometimes (very rarely) commit dates are wrong, so the latest commit</span>
        <span class="c1"># is not actually the head. The magic below is to account for this</span>
        <span class="n">commits</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">sha</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits</span><span class="p">}</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">parent_shas</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commits</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">heads</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">commits</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">parents</span>

        <span class="c1"># it is possible that there is more than one head.</span>
        <span class="c1"># E.g. it happens when HEAD is moved manually (git reset)</span>
        <span class="c1"># and continued with a separate chain of commits.</span>
        <span class="c1"># in this case, let&#39;s just use the latest one</span>
        <span class="c1"># actually, storing refs would make it much simpler</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">commits</span><span class="p">[</span><span class="n">sha</span><span class="p">]</span> <span class="k">for</span> <span class="n">sha</span> <span class="ow">in</span> <span class="n">heads</span><span class="p">),</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">authored_at</span> <span class="ow">or</span> <span class="n">DAY_Z</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the first commit SHA by following first parents</span>

<span class="sd">        &gt;&gt;&gt; Project(&#39;user2589_minicms&#39;).tail</span>
<span class="sd">        &#39;1e971a073f40d74a1e72e07c682e1cba0bae159b&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">commits</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">sha</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits</span><span class="p">}</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">parent_shas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commits</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">parent_shas</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sha</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sha</span> <span class="ow">in</span> <span class="n">pts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">parent_shas</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sha</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commits_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a commit chain by following only the first parent, to mimic</span>
<span class="sd">        https://git-scm.com/docs/git-log#git-log---first-parent .</span>
<span class="sd">        Thus, you only get a small subset of the full commit tree:</span>

<span class="sd">        &gt;&gt;&gt; p = Project(&#39;user2589_minicms&#39;)</span>
<span class="sd">        &gt;&gt;&gt; set(c.sha for c in p.commits_fp).issubset(p.commit_shas)</span>
<span class="sd">        True</span>

<span class="sd">        In scenarios where branches are not important, it can save a lot</span>
<span class="sd">        of computing.</span>

<span class="sd">        Note: commits will come in order from the latest to the earliest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Simplified version of self.head():</span>
        <span class="c1">#   - slightly less precise,</span>
        <span class="c1">#   - 20% faster</span>
        <span class="c1">#</span>
        <span class="c1"># out of 500 randomly sampled projects, 493 had the same head.</span>
        <span class="c1"># In the remaining 7:</span>
        <span class="c1">#     2 had the same commit chain length,</span>
        <span class="c1">#     3 had one more commit</span>
        <span class="c1">#     1 had two more commits</span>
        <span class="c1">#     1 had three more commits</span>
        <span class="c1"># Execution time:</span>
        <span class="c1">#   simplified version (argmax): ~153 seconds</span>
        <span class="c1">#   self.head(): ~190 seconds</span>

        <span class="c1"># at this point we know all commits are in the dataset</span>
        <span class="c1"># (validated in __iter___)</span>
        <span class="n">commits</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">sha</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits</span><span class="p">}</span>
        <span class="n">commit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">commits</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">authored_at</span> <span class="ow">or</span> <span class="n">DAY_Z</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">commit</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># here there is no guarantee commit is in the dataset</span>
                <span class="n">first_parent</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">parent_shas</span> <span class="ow">and</span> <span class="n">commit</span><span class="o">.</span><span class="n">parent_shas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">ObjectNotFound</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">yield</span> <span class="n">commit</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_parent</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">commit</span> <span class="o">=</span> <span class="n">commits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_parent</span><span class="p">,</span> <span class="n">Commit</span><span class="p">(</span><span class="n">first_parent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">toURL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      Get the URL for a given project URI</span>
<span class="sd">      &gt;&gt;&gt; Project(&#39;CS340-19_lectures&#39;).toURL()</span>
<span class="sd">      &#39;http://github.com/CS340-19/lectures&#39;</span>
<span class="sd">      &#39;&#39;&#39;</span>
      <span class="n">p_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span>
      <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">toUrlMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bb&quot;</span><span class="p">:</span> <span class="s2">&quot;bitbucket.org&quot;</span><span class="p">,</span> <span class="s2">&quot;gl&quot;</span><span class="p">:</span> <span class="s2">&quot;gitlab.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;android.googlesource.com&quot;</span><span class="p">:</span> <span class="s2">&quot;android.googlesource.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bioconductor.org&quot;</span><span class="p">:</span> <span class="s2">&quot;bioconductor.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;drupal.com&quot;</span><span class="p">:</span> <span class="s2">&quot;git.drupal.org&quot;</span><span class="p">,</span> <span class="s2">&quot;git.eclipse.org&quot;</span><span class="p">:</span> <span class="s2">&quot;git.eclipse.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;git.kernel.org&quot;</span><span class="p">:</span> <span class="s2">&quot;git.kernel.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;git.postgresql.org&quot;</span><span class="p">:</span> <span class="s2">&quot;git.postgresql.org&quot;</span> <span class="p">,</span>
        <span class="s2">&quot;git.savannah.gnu.org&quot;</span><span class="p">:</span> <span class="s2">&quot;git.savannah.gnu.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;git.zx2c4.com&quot;</span><span class="p">:</span> <span class="s2">&quot;git.zx2c4.com&quot;</span> <span class="p">,</span>
        <span class="s2">&quot;gitlab.gnome.org&quot;</span><span class="p">:</span> <span class="s2">&quot;gitlab.gnome.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kde.org&quot;</span><span class="p">:</span> <span class="s2">&quot;anongit.kde.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;repo.or.cz&quot;</span><span class="p">:</span> <span class="s2">&quot;repo.or.cz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;salsa.debian.org&quot;</span><span class="p">:</span> <span class="s2">&quot;salsa.debian.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sourceforge.net&quot;</span><span class="p">:</span> <span class="s2">&quot;git.code.sf.net/p&quot;</span><span class="p">}</span>

      <span class="k">for</span> <span class="n">URL</span> <span class="ow">in</span> <span class="n">toUrlMap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">URL_</span> <span class="o">=</span> <span class="n">URL</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
        <span class="k">if</span> <span class="n">p_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">URL_</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p_name</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">URL</span> <span class="o">==</span> <span class="s2">&quot;sourceforge.net&quot;</span><span class="p">):</span>
          <span class="n">replacement</span> <span class="o">=</span> <span class="n">toUrlMap</span><span class="p">[</span><span class="n">URL</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
          <span class="n">p_name</span> <span class="o">=</span> <span class="n">p_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">URL_</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
          <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="k">break</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span> 
        <span class="n">p_name</span> <span class="o">=</span> <span class="s2">&quot;github.com/&quot;</span> <span class="o">+</span> <span class="n">p_name</span>
 
      <span class="n">p_name</span> <span class="o">=</span> <span class="n">p_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span> <span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="n">p_name</span>  
    
    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">author_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">decomp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;project_authors&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">author_name</span> 
        <span class="k">for</span> <span class="n">author_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">author_name</span> <span class="ow">and</span> <span class="n">author_name</span> <span class="o">!=</span> <span class="s1">&#39;EMPTY&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="File"><a class="viewcode-back" href="../index.html#oscar.File">[docs]</a><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="n">_Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Files are initialized with a path, starting from a commit root tree:</span>

<span class="sd">        &gt;&gt;&gt; File(&#39;.gitignore&#39;)  # doctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; File(&#39;docs/Index.rst&#39;)  # doctest: +SKIP</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
    <span class="n">_keys_registry_dtype</span> <span class="o">=</span> <span class="s1">&#39;file_commits&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">commit_shas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; SHA1 of all commits changing this file</span>

<span class="sd">        **NOTE: this relation considers only diff with the first parent,</span>
<span class="sd">        which substantially limits its application**</span>

<span class="sd">        &gt;&gt;&gt; commits = File(&#39;minicms/templatetags/minicms_tags.py&#39;).commit_shas</span>
<span class="sd">        &gt;&gt;&gt; len(commits) &gt; 0</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(commits, tuple)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(commits[0], str)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; len(commits[0]) == 40</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="c1">#if not file_path.endswith(&quot;\n&quot;):</span>
        <span class="c1">#    file_path += &quot;\n&quot;</span>
        <span class="n">tch_path</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="s1">&#39;file_commits&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_fnv_keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slice20</span><span class="p">(</span><span class="n">read_tch</span><span class="p">(</span><span class="n">tch_path</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; All commits changing the file</span>

<span class="sd">        .. note: this relation considers only diff with the first parent,</span>
<span class="sd">            which substantially limits its application</span>

<span class="sd">        &gt;&gt;&gt; cs = tuple(File(&#39;minicms/templatetags/minicms_tags.py&#39;).commits)</span>
<span class="sd">        &gt;&gt;&gt; len(cs) &gt; 0</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(cs[0], Commit)</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_shas</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">Commit</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">author</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span>
            <span class="k">except</span> <span class="n">ObjectNotFound</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">author</span> <span class="o">!=</span> <span class="s1">&#39;GitHub Merge Button &lt;merge-button@github.com&gt;&#39;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Author"><a class="viewcode-back" href="../index.html#oscar.Author">[docs]</a><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">_Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Authors are initialized with a combination of name and email, as they</span>
<span class="sd">    appear in git configuration.</span>

<span class="sd">        &gt;&gt;&gt; Author(&#39;John Doe &lt;john.doe@aol.com&gt;&#39;)  # doctest: +SKIP</span>

<span class="sd">    At this point we don&#39;t have a relation to map all aliases of the same</span>
<span class="sd">    author, so keep in mind this object represents an alias, not a person.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;author&#39;</span>
    <span class="n">_keys_registry_dtype</span> <span class="o">=</span> <span class="s1">&#39;author_commits&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_email</span> <span class="o">=</span> <span class="n">full_email</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Author</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">full_email</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">commit_shas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; SHA1 of all commits authored by the Author</span>

<span class="sd">        &gt;&gt;&gt; commits = Author(&#39;user2589 &lt;valiev.m@gmail.com&gt;&#39;).commit_shas</span>
<span class="sd">        &gt;&gt;&gt; len(commits) &gt; 50</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(commits, tuple)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(commits[0], str)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; len(commits[0]) == 40</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">slice20</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;author_commits&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A generator of all Commit objects authored by the Author</span>

<span class="sd">        &gt;&gt;&gt; commits = tuple(Author(&#39;user2589 &lt;valiev.m@gmail.com&gt;&#39;).commits)</span>
<span class="sd">        &gt;&gt;&gt; len(commits) &gt; 50</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(commits[0], Commit)</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Commit</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="k">for</span> <span class="n">sha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_shas</span><span class="p">)</span>
    
    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">project_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; URIs of projects where author has committed to </span>
<span class="sd">A generator of all Commit objects authored by the Author</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">decomp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;author_projects&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">project_name</span>
          <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">project_name</span> <span class="ow">and</span> <span class="n">project_name</span> <span class="o">!=</span> <span class="s1">&#39;EMPTY&#39;</span><span class="p">)</span>
    
    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">torvald</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">decomp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_tch</span><span class="p">(</span><span class="s1">&#39;author_trpath&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)))</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">oscar</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Marat (@cmu.edu).
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>